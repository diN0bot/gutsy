extends layout
block append scripts
  script(src='/static/js/defects.js')
  script
    $(function() {
      $("table#defects").tablesorter();
    });

block content
  .container
    .content
      if version_one
        h1 VersionOne - Open Defects
        if version_one.error
          p The version_one API returned the following error:
          p.alert!=trace(version_one.error)
        else
          div
            - var byAge = new Object();
            - var now = new Date();
            - var defectCreateDate
            - var diff
            - byAge['Less than One'] = [];
            - byAge['1+'] = [];
            - byAge['5+'] = [];
            - byAge['10+'] = [];
            - byAge['30+'] = [];
            - each asset, i in version_one.data.defects
              - defectCreateDate = new Date(asset.attributes['CreateDate']);
              - diff = Math.ceil((now.getTime()-defectCreateDate.getTime())/(1000*60*60*24))
              - if (diff <= 1)
                - byAge['Less than One'].push(asset)
              - if (diff <= 5 && diff > 1)
                - byAge['1+'].push(asset)
              - if (diff <= 10 && diff > 5)
                - byAge['5+'].push(asset)
              - if (diff > 10)
                - byAge['10+'].push(asset)
              - if (diff > 30)
                - byAge['30+'].push(asset)
            - each v, k in byAge
              hr
              h2.title \u25B6 #{k} Day(s) old - #{v.length}
              div.table.collapsible
                table#defects.sortable.table-striped.hide
                  thead
                    tr
                      th Created
                      th Priority
                      th Status
                      th Name
                  tbody
                    - each asset in v
                      tr
                        td #{new Date(asset.attributes['CreateDate']).getMonth()+1}/#{new Date(asset.attributes['CreateDate']).getDate()}
                        td #{asset.attributes['Priority.Name'] || '-'}
                        td #{asset.attributes['Status.Name'] || '-'}
                        td
                          a(href="http://#{related_apis.version_one.host}/#{related_apis.version_one.name}/defect.mvc/Summary?oidToken=#{asset.id}") #{asset.attributes['Name']}
